<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ project }} | License Hub</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --accent: #58a6ff;
            --accent-2: #f78166;
            --success: #3fb950;
            --text: #e6edf3;
            --muted: #8b949e;
            --border: #30363d;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            padding: 24px 32px 40px;
        }
        a { color: var(--accent); }
        .shell { max-width: 1200px; margin: 0 auto; }
        .topbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }
        .title-area { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .topbar h1 { margin: 0; }
        .panel {
            background: linear-gradient(145deg, #161b22, #0b0f14);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.35);
        }
        .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        h2 { margin: 0 0 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 9px 10px; text-align: left; }
        th { text-transform: uppercase; letter-spacing: 0.04em; font-size: 12px; color: var(--muted); border-bottom: 1px solid var(--border); }
        tr td { border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        .actions { display: flex; gap: 6px; flex-wrap: nowrap; align-items: center; }
        .row-compact td { white-space: nowrap; }
        button, .ghost {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(88,166,255,0.1);
            color: var(--text);
            cursor: pointer;
            transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
        }
        button.primary { background: linear-gradient(135deg, var(--accent), #2c82e6); border: none; box-shadow: 0 10px 35px rgba(88,166,255,0.35); }
        button.danger { background: rgba(247, 129, 102, 0.15); border-color: rgba(247, 129, 102, 0.5); color: #ffc7bb; }
        button:hover, .ghost:hover { transform: translateY(-1px); }
        .muted { color: var(--muted); font-size: 14px; }
        .status { font-size: 14px; margin-top: 8px; }
        .pill { padding: 6px 10px; border-radius: 8px; background: rgba(63,185,80,0.12); color: var(--success); font-weight: 600; border: 1px solid rgba(63,185,80,0.4); }
        .pill.warning { background: rgba(247,129,102,0.15); color: #ffb4a2; border-color: rgba(247,129,102,0.4); }
        .table-container { overflow: auto; }
        .flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        input[type="file"] { width: 100%; color: var(--text); }
        .subtitle { color: var(--muted); margin: 0; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 12px; }
        .controls select { background: #0d1117; border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 8px; }
        .mini-upload { display: grid; grid-template-columns: 1.3fr auto auto; gap: 8px; align-items: center; background: rgba(22,27,34,0.75); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
        .mini-upload label { font-size: 13px; color: var(--muted); }
        .mini-upload input[type="file"] { padding: 6px; }
        .pagination { display: flex; align-items: center; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .tag { background: rgba(88,166,255,0.14); padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(88,166,255,0.35); font-size: 13px; color: var(--accent); }
    </style>
</head>
<body>
<div id="app"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script>
const projectName = {{ project|tojson }};
const initialLicenses = {{ licenses|tojson }};

const e = React.createElement;

function Pill({ text, tone = "success" }) {
    const className = tone === "warning" ? "pill warning" : "pill";
    return e("span", { className }, text);
}

function ActionButton({ onClick, label, kind = "ghost", disabled = false }) {
    const className = kind === "danger" ? "danger" : kind === "primary" ? "primary" : "ghost";
    return e("button", { className, type: "button", onClick, disabled }, label);
}

function UploadBox({ onUpload, status }) {
    const fileRef = React.useRef(null);

    const handleUpload = async () => {
        if (!fileRef.current || !fileRef.current.files.length) {
            onUpload(null, "Pick PDF files first.");
            return;
        }

        const formData = new FormData();
        for (const file of fileRef.current.files) {
            formData.append("files", file);
        }
        await onUpload(formData, "Uploading…");
        if (fileRef.current) fileRef.current.value = "";
    };

    return e("div", { className: "mini-upload" }, [
        e("label", { htmlFor: "miniFiles" }, "Upload PDFs"),
        e("input", { id: "miniFiles", ref: fileRef, type: "file", name: "files", accept: "application/pdf", multiple: true }),
        e(ActionButton, { onClick: handleUpload, label: status === "Uploading…" ? "Uploading" : "Upload", kind: "primary" }),
    ]);
}

function TableRow({ license, onCopy, onShare, onDelete }) {
    const typeTone = license.keyword && license.keyword !== "Unknown" ? "success" : "warning";
    const dateTone = license.expiration && license.expiration !== "Unknown" ? "success" : "warning";

    return e("tr", { className: "row-compact", id: `row-${license.filename}` }, [
        e("td", null, license.filename),
        e("td", null, license.code || "Not Found"),
        e("td", null, e(Pill, { text: license.keyword || "Unknown", tone: typeTone })),
        e("td", null, e(Pill, { text: license.expiration || "Unknown", tone: dateTone })),
        e("td", null, e("div", { className: "actions" }, [
            e(ActionButton, { onClick: () => onCopy(license.code || ""), label: "Copy code" }),
            e(ActionButton, { onClick: () => onShare(license.filename), label: "Share link" }),
            e(ActionButton, { onClick: () => onDelete(license.filename), label: "Delete", kind: "danger" }),
        ])),
    ]);
}

function App({ project, startLicenses }) {
    const [licenses, setLicenses] = React.useState(startLicenses);
    const [filter, setFilter] = React.useState("ALL");
    const [perPage, setPerPage] = React.useState(5);
    const [page, setPage] = React.useState(1);
    const [status, setStatus] = React.useState("Waiting for files…");
    const [uploading, setUploading] = React.useState(false);

    const filtered = React.useMemo(() => {
        return licenses.filter((lic) => {
            if (filter === "ALL") return true;
            const candidate = (lic.keyword || lic.code || "").toUpperCase();
            return candidate.includes(filter);
        });
    }, [licenses, filter]);

    const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
    const currentPage = Math.min(page, totalPages);
    const start = (currentPage - 1) * perPage;
    const pageItems = filtered.slice(start, start + perPage);

    const updateStatus = (text) => setStatus(text);

    const copyToClipboard = async (text) => {
        try {
            await navigator.clipboard.writeText(text || "");
            updateStatus("Registration code copied");
        } catch (err) {
            updateStatus("Clipboard unavailable");
            alert("Copy failed. Please copy manually.");
        }
    };

    const shareLink = async (filename) => {
        const url = `${window.location.origin}/project/${encodeURIComponent(project)}/download/${encodeURIComponent(filename)}`;
        try {
            await navigator.clipboard.writeText(url);
            updateStatus("Shareable download link copied");
        } catch (err) {
            updateStatus("Clipboard unavailable");
            alert(url);
        }
    };

    const deleteFile = async (filename) => {
        if (!confirm(`Delete ${filename}?`)) return;
        const res = await fetch(`/project/${encodeURIComponent(project)}/delete/${encodeURIComponent(filename)}`, { method: "DELETE" });
        if (res.ok) {
            setLicenses((prev) => prev.filter((lic) => lic.filename !== filename));
            updateStatus(`${filename} removed`);
        } else {
            updateStatus("Delete failed");
            alert("Delete failed");
        }
    };

    const uploadFiles = async (formData, startMessage) => {
        if (!formData) {
            updateStatus(startMessage);
            return;
        }
        setUploading(true);
        updateStatus(startMessage);
        try {
            const res = await fetch(`/project/${encodeURIComponent(project)}/upload`, { method: "POST", body: formData });
            const result = await res.json().catch(() => ({ uploaded: [], skipped: [] }));
            if (res.ok) {
                updateStatus(`Uploaded: ${result.uploaded.length}, Skipped: ${result.skipped.length}`);
                if (result.uploaded?.length) {
                    // Reload to pull updated metadata server-side for consistency
                    window.location.reload();
                }
            } else {
                updateStatus("Upload failed");
                alert("Upload failed.");
            }
        } catch (err) {
            updateStatus("Upload failed");
            alert("Upload failed.");
        } finally {
            setUploading(false);
        }
    };

    const pageInfo = pageItems.length ? `${start + 1}-${start + pageItems.length} of ${filtered.length}` : `0 of ${filtered.length}`;

    return e("div", { className: "shell" }, [
        e("div", { className: "topbar" }, [
            e("div", { className: "title-area" }, [
                e("h1", null, project),
                e("p", { className: "subtitle" }, "Upload, extract and share license PDFs from a clean workspace."),
            ]),
            e(UploadBox, { onUpload: uploadFiles, status: uploading ? "Uploading…" : "Upload" }),
        ]),

        e("div", { className: "grid" }, [
            e("div", { className: "panel" }, [
                e("div", { className: "flex", style: { justifyContent: "space-between", alignItems: "flex-start", gap: "10px", flexWrap: "wrap" } }, [
                    e("div", null, [
                        e("h2", null, "Licenses"),
                        e("p", { className: "subtitle" }, "Registration codes and expiration hints pulled straight from PDFs."),
                    ]),
                    e("div", { className: "flex", style: { gap: "8px" } }, [
                        e("span", { className: "pill" }, `${licenses.length} files`),
                        e("a", { className: "ghost", href: "/" }, "◀ Back to hub"),
                        e(ActionButton, { label: "Refresh", onClick: () => window.location.reload() }),
                    ]),
                ]),

                e("div", { className: "controls" }, [
                    e("div", { className: "tag" }, "Filters"),
                    e("label", { className: "subtitle", htmlFor: "typeFilter" }, "License type"),
                    e("select", {
                        id: "typeFilter",
                        value: filter,
                        onChange: (ev) => { setFilter(ev.target.value); setPage(1); },
                    }, [
                        e("option", { value: "ALL" }, "All"),
                        e("option", { value: "FGT" }, "FGT"),
                        e("option", { value: "FAC" }, "FAC"),
                        e("option", { value: "FTM" }, "FTM"),
                        e("option", { value: "FIC" }, "FIC"),
                    ]),
                    e("label", { className: "subtitle", htmlFor: "perPage" }, "Per page"),
                    e("select", {
                        id: "perPage",
                        value: perPage,
                        onChange: (ev) => { setPerPage(parseInt(ev.target.value, 10) || 5); setPage(1); },
                    }, [
                        e("option", { value: 5 }, "5"),
                        e("option", { value: 10 }, "10"),
                    ]),
                    e("div", { className: "status" }, status),
                ]),

                e("div", { className: "table-container" }, [
                    e("table", null, [
                        e("thead", null, e("tr", null, [
                            e("th", null, "PDF"),
                            e("th", null, "Registration Code"),
                            e("th", null, "Type"),
                            e("th", null, "Expiration"),
                            e("th", null, "Actions"),
                        ])),
                        e("tbody", null,
                            pageItems.length
                                ? pageItems.map((lic) => e(TableRow, {
                                    key: lic.filename,
                                    license: lic,
                                    onCopy: copyToClipboard,
                                    onShare: shareLink,
                                    onDelete: deleteFile,
                                }))
                                : e("tr", null, e("td", { colSpan: 5, className: "muted" }, "No licenses match this filter."))
                        ),
                    ]),
                ]),

                e("div", { className: "pagination" }, [
                    e("div", { className: "status" }, pageInfo),
                    e("div", { className: "flex", style: { gap: "8px" } }, [
                        e(ActionButton, { label: "Prev", onClick: () => setPage(Math.max(1, currentPage - 1)) }),
                        e(ActionButton, { label: "Next", onClick: () => setPage(Math.min(totalPages, currentPage + 1)) }),
                    ]),
                ]),
            ]),
        ]),
    ]);
}

const appRoot = document.getElementById("app");
if (appRoot) {
    ReactDOM.createRoot(appRoot).render(e(App, { project: projectName, startLicenses: initialLicenses }));
}
</script>
</body>
</html>
